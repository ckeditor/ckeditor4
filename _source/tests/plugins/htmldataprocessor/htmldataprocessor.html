<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>Plugin: htmldataprocessor</title>
	<link rel="stylesheet" type="text/css" href="../../test.css" />
	<script type="text/javascript" src="../../../../ckeditor_source.js"></script> <!-- %REMOVE_LINE%
	<script type="text/javascript" src="../../../ckeditor.js"></script>
	%REMOVE_LINE% -->
	<script type="text/javascript" src="../../test.js"></script>
	<script type="text/javascript">

CKEDITOR.plugins.load( 'htmldataprocessor' );

	</script>
	<script type="text/javascript">
	//<![CDATA[

var testCase;

CKEDITOR.test.addTestCase( testCase = (function()
{
	// Local references.
	var assert = CKEDITOR.test.assert;

	// In these tests, we may "reset" the writer rules to avoid it formatting
	// the output, making the assertion easier to the done. We don't need to
	// test formatting features here, so this is ok.
	var getDataProcessor = function()
	{
		var dataProcessor = new CKEDITOR.htmlDataProcessor();
		dataProcessor.writer._.rules = [];
		return dataProcessor;
	};

	// These tests go far beyond the strict htmlDataProcessor code testing. We
	// are actually testing the entire parsing system here. The combination of
	// htmlParser and htmlWriter inside htmlDataProcessor is useful in this
	// sense.

	return {
		test_toDataFormat_1a : function()
		{
			var element = new CKEDITOR.dom.element.createFromHtml( '<div><p>Test</p></div>' );

			assert.areSame( '<p>Test</p>', getDataProcessor().toDataFormat( element.getHtml() ) );
		},

		test_toDataFormat_1b : function()
		{
			var element = new CKEDITOR.dom.element.createFromHtml( '<div><x:x>Test</x:x></div>' );

			// IE adds the XML namespace tag.
			if ( CKEDITOR.env.ie )
				assert.areSame( '<?xml:namespace prefix="x" /><x:x>Test</x:x>', getDataProcessor().toDataFormat( element.getHtml() ) );
			else
				assert.areSame( '<x:x>Test</x:x>', getDataProcessor().toDataFormat( element.getHtml() ) );
		},

		test_toDataFormat_2a : function()
		{
			var element = new CKEDITOR.dom.element.createFromHtml( '<div><br /><p>Test</p></div>' );

			assert.areSame( '<br /><p>Test</p>', getDataProcessor().toDataFormat( element.getHtml() ) );
		},

		test_toDataFormat_2b : function()
		{
			var element = new CKEDITOR.dom.element.createFromHtml( '<div><x:x></x:x><p>Test</p></div>' );

			// IE adds the XML namespace tag.
			if ( CKEDITOR.env.ie )
				assert.areSame( '<?xml:namespace prefix="x" /><x:x></x:x><p>Test</p>', getDataProcessor().toDataFormat( element.getHtml() ) );
			else
				assert.areSame( '<x:x></x:x><p>Test</p>', getDataProcessor().toDataFormat( element.getHtml() ) );
		},

		test_toDataFormat_3 : function()
		{
			var element = new CKEDITOR.dom.element.createFromHtml( '<div><x:x><p>Test</p></div>' );

			assert.areSame( '<x:x><p>Test</p></x:x>', getDataProcessor().toDataFormat( element.getHtml() ) );
		},

		test_toDataFormat_ticket_2774 : function()
		{
			var element = new CKEDITOR.dom.element.createFromHtml( '<div><P class=MsoNormal><B><I><SPAN lang=EN-US><o:p>Test</o:p></SPAN></I></B></P></div>' );

			// IE adds the XML namespace tag.
			if ( CKEDITOR.env.ie )
				assert.areSame( '<p class="MsoNormal"><b><i><span lang="EN-US"><?xml:namespace prefix="o" /><o:p>Test</o:p></span></i></b></p>', getDataProcessor().toDataFormat( element.getHtml() ) );
			else
				assert.areSame( '<p class="MsoNormal"><b><i><span lang="EN-US"><o:p>Test</o:p></span></i></b></p>', getDataProcessor().toDataFormat( element.getHtml() ) );
		},

		test_toDataFormat_ticket_3036_1 : function()
		{
			assert.areSame( '<input autocomplete="off" checked="checked" type="checkbox" />',
				getDataProcessor().toDataFormat( '<INPUT type="checkbox" CHECKED  autocomplete=off>' ) );
		},

		test_toDataFormat_ticket_3036_2 : function()
		{
			assert.areSame( '<input autocomplete="off" type="checkbox" unknown="" />',
				getDataProcessor().toDataFormat( '<INPUT type="checkbox" UNKNOWN  autocomplete=off>' ) );
		},

		test_toDataFormat_ticket_2886_1 : function()
		{
			var editor = CKEDITOR.instances.editor1;
			var test = this;
			var isReady = !!editor.dataProcessor;

			if ( !isReady )
			{
				editor.on( 'instanceReady', function()
				{
					isReady = true;
				} );
			}

			this.wait( function()
				{
					if ( !isReady )
					{
						test.wait( arguments.callee, 100 );
						return;
					}

					assert.areSame( '<p>\n\t&nbsp;</p>\n',
						editor.dataProcessor.toDataFormat( '<p></p>' ) );
				}, 100 );
		},

		test_toDataFormat_ticket_2886_2 : function()
		{
			var dataProcessor = CKEDITOR.instances.editor1.dataProcessor;

			var source = '<p>Some text<br><br><br></p>';
			if ( CKEDITOR.env.ie )
				source = '<p>Some text<br><br></p>';
			assert.areSame( '<p>\n\tSome text<br />\n\t<br />\n\t&nbsp;</p>\n',
				dataProcessor.toDataFormat( source ) );
		},

		test_toDataFormat_ticket_2886_3 : function()
		{
			var dataProcessor = CKEDITOR.instances.editor1.dataProcessor;

			assert.areSame( '<p>\n\tSome text<br />\n\t<br />\n\t<br />\n\tSome more text</p>\n',
				dataProcessor.toDataFormat( '<p>Some text<br><br><br>Some more text</p>' ) );
		},

		test_toDataFormat_ticket_2886_4 : function()
		{
			var dataProcessor = CKEDITOR.instances.editor1.dataProcessor;

			assert.areSame( '<p>\n\tSome text<br />\n\t<br />\n\t&nbsp;</p>\n',
				dataProcessor.toDataFormat( '<p>Some text<br><br>&nbsp;</p>' ) );
		},

		test_toDataFormat_ticket_2886_5 : function()
		{
			if ( CKEDITOR.env.ie )
				return;

			var dataProcessor = CKEDITOR.instances.editor1.dataProcessor;

			assert.areSame( '<p>\n\t&nbsp;</p>\n',
				dataProcessor.toDataFormat( '<p><br></p>' ) );
		},

		test_toDataFormat_ticket_2886_6 : function()
		{
			var dataProcessor = CKEDITOR.instances.editor1.dataProcessor;

			var source = '<p><br><br></p>';
			if ( CKEDITOR.env.ie )
				source = '<p><br></p>';

			assert.areSame( '<p>\n\t<br />\n\t&nbsp;</p>\n',
				dataProcessor.toDataFormat( source ) );
		},

		test_toHtml_ticket_2886_1 : function()
		{
			var dataProcessor = CKEDITOR.instances.editor1.dataProcessor;

			var expected = '<p><br /></p>';
			if ( CKEDITOR.env.ie )
				expected = '<p>\xa0</p>';
			assert.areSame( expected, dataProcessor.toHtml( '<p></p>' ) );
		},

		test_toHtml_ticket_2886_2 : function()
		{
			var dataProcessor = CKEDITOR.instances.editor1.dataProcessor;

			var expected = '<p>Some text<br />Some other text</p>';
			assert.areSame( expected, dataProcessor.toHtml( '<p>Some text<br>Some other text</p>' ) );
		},

		test_toHtml_ticket_2886_3 : function()
		{
			var dataProcessor = CKEDITOR.instances.editor1.dataProcessor;

			var expected = '<p>Some text<br /><br /></p>';
			if ( CKEDITOR.env.ie )
				expected = '<p>Some text<br />\xa0</p>';
			assert.areSame( expected, dataProcessor.toHtml( '<p>Some text<br>&nbsp;</p>' ) );
		},

		test_toHtml_ticket_2886_4 : function()
		{
			var dataProcessor = CKEDITOR.instances.editor1.dataProcessor;

			var expected = '<p>Some text</p>';
			assert.areSame( expected, dataProcessor.toHtml( '<p>Some text<br></p>' ));
		},

		name : document.title
	};
})() );

//window.onload = function()
//{
//	testCase.test_toDataFormat_ticket_3036();
//}

	//]]>
	</script>
</head>
<body>
	<textarea id="editor1" class="ckeditor" cols="80" rows="10"></textarea>
</body>
</html>
